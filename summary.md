# ネットワークはいいぞ(NWまとめ)  

## 目次  
1. プロトコル  
2. OSI参照モデル  
3. 物理層  
4. データリンク層
5. ネットワーク層
6. トランスポート層
7. セッション層、プレゼンテーション層、アプリケーション層

### 1. プロトコル  
コンピュータは0と1で動作している。
コンピュータ同士で通信をするときに、お互いがルールを共有する必要がある。  
この通信における共有するルールのことを「プロトコル」という。  

### 2. OSI参照モデル
プロトコルスタックを7層に分割した、コンピュータ通信における概念モデル。  
  
通信プロトコルを階層化することによって、ある階層のプロトコルの実装が、  
別の階層のプロトコルに影響を及ばないようにすることができる。  
- 7, アプリケーション層　　：アプリケーションの種類の規定  
- 6, プレゼンテーション層　：データフォーマットの交換  
- 5, セッション層　　　　　：コネクションの確立や切断。トランスポート層以下の管理  
- 4, トランスポート層　　　：ノード間のデータ転送の管理  
- 3, ネットワーク層　　　　：データ転送を行う機器間のアドレスの管理や経路選択  
- 2, データリンク層　　　　：直接接続された機器間のデータフレームの識別と転送  
- 1, 物理層　　　　　　　　：物理的な接続方法の規定  

#### Tips1 カプセル化と非カプセル化
ネットワークで「データを送信するとき」と「データを受信するとき」で  
コンピュータが以下の動作をする。


```
1. データを送信するとき

   アプリケーション層 
-> プレゼンテーション層
-> セッション層
-> トランスポート層
-> ネットワーク層
-> データリンク層
-> 物理層

データの送信において、各層でヘッダーを付加して、下の階層にデータを渡す。
このヘッダーを付加することを「カプセル化」という。
```  
```
2. データを受信するとき

   アプリケーション層 
<- プレゼンテーション層
<- セッション層
<- トランスポート層
<- ネットワーク層
<- データリンク層
<- 物理層

データの受信において、各層でヘッダーを取り外して、上の階層にデータを渡す。
このヘッダーを取り外すことを「非カプセル化」という。
```  


### 3. 物理層
1bit(0 と 1) を判別する。
イーサネットフレームにおける、プリアンブルを「データのはじまり」とする。  
```
IEEE802.3
10101010 10101010 10101010 10101010 10101010 10101010 10101011
```  
  
物理層では3.3V以上の電気信号を「1」とする。  
ネットワーク機器としては、リピータハブ(ノンインテリジェンスハブ)が該当する。  
  
  
### 4. データリンク層
同一のネットワークに、コンピュータを複数接続する環境において、  
物理層だけでは「誰宛のデータなのか」を判別することが困難になってしまう。  
  
ここで登場するのが、<strong>「MACアドレス」</strong> 。  
MAC は「Media Access Control」の略。  
  
```
MACアドレスは、NIC(ネットワークインターフェースカード)に割り当てられる固有の識別子。
48ビット(6バイト)で構成されており、16進数表記(4ビット1文字)で、":"区切りとなっている。
- 前半24ビット = ベンダーID
- 後半24ビット = 製品番号

例) Hewlett Packard Enterprise
14:02:EC:00:00:00

IANAによって、ベンダーIDは管理されているため、MACアドレスから機器を特定することは可能。
https://uic.jp/mac/address/1402ec/
```  
  
同一ネットワーク上に同じ識別子でなければ、問題ないためAndroid端末ではMACアドレスをランダムにすることができる。  
仮想環境におけるvNICの場合、ランダムにMACアドレスを生成するため、衝突防止に努めること。  
  
ネットワーク機器としては、スイッチングハブ(以下、スイッチ)がある。  
スイッチは、直接接続されている機器に対して、  
ブロードキャストフレームを流してMACアドレスを学習し、MACアドレステーブルをつくる。  
MACアドレステーブルでデータの受け渡しを行うことで、トラフィックの無駄をなくす。  
  
  
### 5. ネットワーク層
スイッチが、すべての端末のMACアドレスを覚えることは大変非効率であり、無駄が多い。  
そこで、IPアドレスがある。インターネット上の特定の端末を識別するための識別子である。  
  
NICに対して、OSが割り当てるもの。   
MACアドレスが物理アドレスといわれる代わりに、IPアドレスは論理アドレスともいわれる。  
  
```
IPアドレス(ここではIPv4とする)は32ビットで構成される。
10進数で表記され、1Byte(8ビット)の4オクテットとして、0.0.0.0 ~ 255.255.255.255の範囲で表す。

ex) LANのある特定のホストに割り当てられる
192.168.0.1/24

ここでいう/24は、IPアドレスとは別に「サブネットマスク」という。
そもそもIPアドレスは、「ネットワーク部」と「ホスト部」に分けられる。

ネットワーク部　：特定のネットワークを識別するための識別子
ホスト部　　　　：特定のホストを識別するための識別子

サブネットマスクは、この「ネットワーク部」と「ホスト部」を区切るための値。
サブネットマスクは、CIDR表記(/N)と2進数表記がある。
2進数表記の場合は以下。
IPアドレス　　　　： 192.168.0.1
サブネットマスク　： 11111111.11111111.11111111.00000000 (CIDRでは/24)

IPアドレスは、さらに以下の分類に以下に分類される。
ネットワークアドレス　　　： サブネットマスクとIPアドレスの論理積
ブロードキャストアドレス　： ホスト部のIPアドレスをすべて「1」としたIPアドレス
ホストアドレス　　　　　　： ホストに一意に割りあてられるアドレス(2^n-2個, n = 32 - サブネットマスクの「1」の桁数)
ネットワークアドレスとブロードキャストアドレスは、ホストに割り当て不可能。

ex) 192.168.0.N/24 (0 <= n <= 255)
ネットワークアドレス　　　： 192.168.0.0
ブロードキャストアドレス　： 192.168.0.255
ホストアドレス　　　　　　： 192.168.0.1 ~ 192.168.0.254 (254ホスト = 2^8-2)
```  
  
IPアドレスは、さらに以下の2種類に割り当てられる。  
- グローバルIPアドレス
- ローカルIPアドレス

これらの区分は、「IPv4の枯渇問題の解消」を目的としている。  
インターネットに接続するデバイスが増え続けることで、割り当てられるIPv4アドレスがない。  
IPv4アドレスを集約するIPアドレスとしてローカルIPアドレスを用意できる。
  
企業や家庭などの一般的な利用では、ISP(インターネット・サービス・プロバイダ)と契約して  
グローバルIPアドレスを取得する。  
  
  
```
ローカルIPアドレスについて

クラスA： 10.0.0.0 ~ 10.255.255.255 /8
クラスB： 172.16.0.0 ~ 172.31.255.255 /16
クラスC： 192.168.0.0 ~ 192.168.255.255 /24

クラス区分は、現代のクラスレスなネットワークは気にしなくてもよいが歴史的経緯としておぼえておくとよい。
なお、説明は割愛させてもらう。(クラスレスなサブネットの構築に大変重要ではあるが)

一応、大規模・中規模・小規模程度の感覚で使用するとおぼえておくとよい。
ちなみに、企業ネットワーク(イントラネット)においては、ほとんどクラスAを利用する。
```  

#### Tips2 IPアドレスとMACアドレスの紐づけ
データ転送において、宛先MACアドレスが分からないことがある。  
このとき、宛先IPアドレスが分かっている前提で、ARP(Address Resolution Protocol)というプロトコルを利用する。  
  
ARPは、ブロードキャストフレームを転送して、該当の宛先IPアドレスを保持するホストからの応答をもとに  
宛先のMACアドレスを求めるプロトコル。

これとは逆のRAPR(Reverse Address Resolution Protocol)があるが、今はもう使わない。  
  
#### Tips3 グローバルIPアドレスとローカルIPアドレスの紐づけ
グローバルIPアドレスでルータまで届いたパケットのIPアドレスは、NAT(Network Address Translation)というプロトコルによって  
ローカルIPアドレスに変換することができる。  
  
ISPのネットワーク機器(たとえば、モデム)と接続しているルータではメモリ上にNATテーブルが展開されており、  
そのNATテーブルをもとにグローバルIPアドレスとローカルIPアドレスの紐づけをする。  
    
さらにポート番号をもとにして、NAT変換するプロトコルをNAPT(Network Address Protocol Translation)という。  
``` グローバルIPアドレス + ポート番号 <=> ローカルIPアドレス + ポート番号 ``` という紐づけをしている。  
  
#### Tips4 IPアドレスの割り当て
「IPアドレスは静的に割り当てる方法(つまり手動)」と「動的に割り当てる方法」の2種類がある。  
  
手動で割り当てる場合、事前にホストがあるネットワークの「割り当て可能なホストアドレス」を知る必要がある。  
また、所属するネットワークのサブネットマスクを合わせた上で、なおかつデフォルトゲートウェイを指定する必要があるため設定は初心者ではむずかしい。
  
動的に割り当てる場合、DHCP(Dynamic Host Configuration Protocol)を利用する。
この方法が通常の利用では一般的なので説明すると、  
- DHCPクライアント
- DHCPサーバ  
の2つがある。  
  
IPアドレスを割り当てたいホストのことをDHCPクライアントといい、IPアドレスの貸し出しを行うホストをDHCPサーバという。  
DHCPサーバは、割り当て可能なIPアドレスの範囲(DHCPプール)を保持しており、この中からDHCPクライアントにIPアドレスを割り当てる。  

通信の流れは以下。
``` 
(1) : DHCPクライアント
(2) : DHCPサーバ

   (1) DHCP Discover 
-> (2) DHCP Offer 
-> (1) DHCP Request 
-> (2) DHCP ACK
```  
  
#### Tips5 ドメインとIPアドレスを紐づける
HTTPやSMTPなどで、ドメイン名を利用して通信をする。  
たとえば、 ``` www.example.com ``` にデータを送りたいとき、  
相手のIPアドレスが分からないとデータを送信することができない。  
  
ドメイン名から、IPアドレスを求めるネットワークの仕組みを  
「DNS(Domain Network System)」という。  
  
DNSには、クライアントとサーバが存在する。  
たとえば、Google Chrome(Webブラウザ)を開いて、検索バーに  
``` https://www.example.com ``` と入力してEnterを押す。  
  
このとき、DNSクライアントはChromeであり、DNSサーバは特に指定がない限りは、  
一般家庭ではルータなどが行う。  
  
詳細な説明は割愛するが、非常に重要なのでかならず学んで覚えることを推奨する。  
  
### 6. トランスポート層  
再送制御などの通信品質を確保すること。  
TCP/UDPが主なプロトコル。  
  
TCP(Transmission Control Protocol) : 送信先にデータが確実に届けることを制御する(そのため、通信速度は比較的遅い)  
UDP(User Datagram Protocol)        : 送信先にデータが届くかどうかを制御しない(そのため、通信速度は比較的早い)  
  
  
|       |  TCP  |  UDP  |
| ----  | ----  | ----  |
| 通信速度      |  遅い   |  速い   |
| 通信品質      |  良い   |  悪い   |
| 利用例      |  メール   |  ライブ配信   |  
  
TCPは、データを送る前に3ウェイハンドシェイクによって、コネクション(論理的な通信路)を確立する。
3ウェイハンドシェイクの通信の流れは以下。(ちなみに、WireSharkで見れば一発で分かるので暇なら触ろう！)  
  
```
(1) 送信元
(2) 送信先

   (1) TCP SYN
-> (2) TCP ACK + SYN
-> (1) TCP ACK
```  
  
- ポート番号
```
コンピュータ通信において、OS上で動作するアプリケーションを識別するための番号。
16ビットで構成されている(範囲は10進数で、0~65535)。

TCP、UDPのどちらについても0~65535のポートが割り当てられる。

区分けが3種類ある。
1) 0     - 1023   
2) 1024  - 49151  
3) 49152 - 65535 

1) ウェルノンポート　　：IANAで管理されている。よく使用されているアプリケーションで使われるポート番号。特定可能だけどできれば覚えよう
2) レジスタードポート　：IANAで管理されている。固有のアプリケーションで登録されていることもあり、ググれば特定可能
3) エフェメラルポート　：IANAは知らない。一時的に利用されるポート番号。どのアプリケーションであるかを特定することは、ポートスキャンすれば特定可能
```  
  
### 7. セッション層、プレゼンテーション層、アプリケーション層
アプリケーションの実装に依存するため、これらの層はひとまとめにされている。

```
ex) HTTP (curl)

$ curl -i https://wwww.example.com

HTTP/2 200
accept-ranges: bytes
age: 414577
cache-control: max-age=604800
content-type: text/html; charset=UTF-8
date: Sun, 17 Apr 2022 03:10:42 GMT
etag: "3147526947"
expires: Sun, 24 Apr 2022 03:10:42 GMT
last-modified: Thu, 17 Oct 2019 07:18:26 GMT
server: ECS (sab/56BB)
vary: Accept-Encoding
x-cache: HIT
content-length: 1256

<!doctype html>
<html>
<head>
    <title>Example Domain</title>

    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type="text/css">
    body {
        background-color: #f0f0f2;
        margin: 0;
        padding: 0;
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;

    }
    div {
        width: 600px;
        margin: 5em auto;
        padding: 2em;
        background-color: #fdfdff;
        border-radius: 0.5em;
        box-shadow: 2px 3px 7px 2px rgba(0,0,0,0.02);
    }
    a:link, a:visited {
        color: #38488f;
        text-decoration: none;
    }
    @media (max-width: 700px) {
        div {
            margin: 0 auto;
            width: auto;
        }
    }
    </style>
</head>

<body>
<div>
    <h1>Example Domain</h1>
    <p>This domain is for use in illustrative examples in documents. You may use this
    domain in literature without prior coordination or asking for permission.</p>
    <p><a href="https://www.iana.org/domains/example">More information...</a></p>
</div>
</body>
</html>
```  
